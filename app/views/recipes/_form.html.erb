<div class="container">
  <%= form_with(model: recipe, local: true, class: "needs-validation", novalidate: true) do |form| %>
    <% if recipe.errors.any? %>
      <div class="alert alert-danger">
        <h4><%= pluralize(recipe.errors.count, "error") %> prohibited this recipe from being saved:</h4>
        <ul class="mb-0">
          <% recipe.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="row">
      <div class="col-md-8">
        <!-- Basic Recipe Info -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Recipe Details</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <%= form.label :title, class: "form-label" %>
              <%= form.text_field :title, class: "form-control" %>
            </div>

            <div class="mb-3">
              <%= form.label :description, class: "form-label" %>
              <%= form.text_area :description, rows: 3, class: "form-control" %>
            </div>

            <div class="row">
              <div class="col-md-4">
                <%= form.label :prep_time, "Prep Time (minutes)", class: "form-label" %>
                <%= form.number_field :prep_time, class: "form-control" %>
              </div>
              <div class="col-md-4">
                <%= form.label :cook_time, "Cook Time (minutes)", class: "form-label" %>
                <%= form.number_field :cook_time, class: "form-control" %>
              </div>
              <div class="col-md-4">
                <%= form.label :servings, class: "form-label" %>
                <%= form.number_field :servings, class: "form-control" %>
              </div>
            </div>

            <div class="mb-3 mt-3">
              <%= form.label :difficulty_level, class: "form-label" %>
              <%= form.select :difficulty_level,
                              options_for_select([
                                                   %w[Easy Easy],
                                                   %w[Medium Medium],
                                                   %w[Hard Hard]
                                                 ], recipe.difficulty_level),
                              { prompt: 'Select difficulty' },
                              { class: "form-select" } %>
            </div>

            <div class="mb-3">
              <%= form.label :instructions, class: "form-label" %>
              <%= form.text_area :instructions, rows: 8, class: "form-control" %>
            </div>
          </div>
        </div>

        <!-- Ingredients Section -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Ingredients</h5>
          </div>
          <div class="card-body">
            <!-- Current Ingredients -->
            <div id="current-ingredients">
              <% if recipe.persisted? && recipe.recipe_ingredients.any? %>
                <% recipe.recipe_ingredients.each do |ri| %>
                  <div class="ingredient-item border rounded p-3 mb-2">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <strong><%= ri.ingredient.name %></strong>
                        <span class="text-muted">- <%= ri.quantity %> <%= ri.unit %></span>
                        <% if ri.notes.present? %>
                          <small class="text-muted">(<%= ri.notes %>)</small>
                        <% end %>
                      </div>
                      <%= link_to recipe_recipe_ingredient_path(recipe, ri),
                                  method: :delete,
                                  class: "btn btn-outline-danger btn-sm",
                                  data: {
                                    turbo_method: :delete,
                                    turbo_confirm: "Remove this ingredient?"
                                  } do %>
                        <i class="bi bi-trash"></i>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              <% else %>
                <p class="text-muted">No ingredients added yet.</p>
              <% end %>
            </div>

            <!-- Add New Ingredient -->
            <div class="border rounded p-3 bg-light"
                 data-controller="ingredient-autocomplete"
                 data-ingredient-autocomplete-recipe-id-value="<%= recipe.id if recipe.persisted? %>">
              <h6>Add Ingredient</h6>

              <div class="mb-3 position-relative">
                <label for="ingredient-search" class="form-label">Search Ingredients</label>
                <input type="text"
                       data-ingredient-autocomplete-target="search"
                       data-action="input->ingredient-autocomplete#search"
                       class="form-control"
                       placeholder="Start typing ingredient name..."
                       autocomplete="off">

                <!-- Search Results Dropdown -->
                <div data-ingredient-autocomplete-target="dropdown"
                     class="position-absolute w-100 bg-white border rounded shadow-sm"
                     style="display: none; z-index: 1000; max-height: 200px; overflow-y: auto;">
                </div>
              </div>

              <!-- Quick Add New Ingredient Form -->
              <div data-ingredient-autocomplete-target="quickAddForm" style="display: none;">
                <div class="alert alert-info">
                  <strong>Ingredient not found!</strong> Add it to the database:
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <input type="text" data-ingredient-autocomplete-target="newName" class="form-control mb-2" placeholder="Ingredient name">
                  </div>
                  <div class="col-md-6">
                    <select data-ingredient-autocomplete-target="newCategory" class="form-select mb-2">
                      <option value="">Select category</option>
                      <option value="Vegetables">Vegetables</option>
                      <option value="Fruits">Fruits</option>
                      <option value="Meat">Meat</option>
                      <option value="Dairy">Dairy</option>
                      <option value="Grains">Grains</option>
                      <option value="Spices">Spices</option>
                      <option value="Other">Other</option>
                    </select>
                  </div>
                </div>
                <button type="button"
                        data-action="click->ingredient-autocomplete#saveNewIngredient"
                        class="btn btn-success btn-sm me-2">
                  Add to Database
                </button>
                <button type="button"
                        data-action="click->ingredient-autocomplete#clearForms"
                        class="btn btn-secondary btn-sm">
                  Cancel
                </button>
              </div>

              <!-- Ingredient Details Form -->
              <div data-ingredient-autocomplete-target="detailsForm" style="display: none;">
                <input type="hidden" data-ingredient-autocomplete-target="selectedId">

                <div class="row">
                  <div class="col-md-4">
                    <label for="ingredient-quantity" class="form-label">Quantity</label>
                    <input type="number" step="0.1" data-ingredient-autocomplete-target="quantity" class="form-control" placeholder="2">
                  </div>
                  <div class="col-md-4">
                    <label for="ingredient-unit" class="form-label">Unit</label>
                    <select data-ingredient-autocomplete-target="unit" class="form-select">
                      <% RecipeIngredient::UNITS.each do |unit| %>
                        <option value="<%= unit %>"><%= unit %></option>
                      <% end %>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label for="ingredient-notes" class="form-label">Notes</label>
                    <input type="text" data-ingredient-autocomplete-target="notes" class="form-control" placeholder="diced, optional">
                  </div>
                </div>

                <div class="mt-3">
                  <% if recipe.persisted? %>
                    <button type="button"
                            data-action="click->ingredient-autocomplete#addToRecipe"
                            class="btn btn-primary">
                      Add to Recipe
                    </button>
                  <% else %>
                    <small class="text-muted">Save recipe first to add ingredients</small>
                  <% end %>
                  <button type="button"
                          data-action="click->ingredient-autocomplete#clearForms"
                          class="btn btn-outline-secondary ms-2">
                    Clear
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="actions">
      <%= form.submit class: "btn btn-success" %>
      <%= link_to 'Cancel', recipes_path, class: "btn btn-outline-secondary ms-2" %>
    </div>
  <% end %>
</div>